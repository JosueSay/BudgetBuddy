{% extends "base.html" %}
{% block content %}

<!-- gestión de categorías (arriba) -->
<section class="panel">
  <h3>gestión de categorías</h3>
  <div class="panel-grid">
    <form method="post" action="/category/create">
      <label>nueva categoría</label>
      <input type="text" name="name" placeholder="ej. restaurante">
      <button type="submit">crear</button>
    </form>

    <form method="post" action="/category/rename">
      <label>renombrar</label>
      <select name="old">
        {% for c in categories %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
      <input type="text" name="new" placeholder="nuevo nombre">
      <button type="submit">renombrar</button>
    </form>

    <form method="post" action="/category/delete">
      <label>eliminar</label>
      <select name="name">
        {% for c in categories %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="danger">eliminar</button>
      <div class="hint tiny">al eliminar, las asignaciones quedan sin categoría</div>
    </form>
  </div>
</section>

<!-- filtros -->
<section class="toolbar">
  <form class="inline" method="get" action="/">
    <input type="text" name="q" placeholder="buscar por nombre…" value="{{ q }}">
    <select name="only">
      <option value="" {{ '' == only and 'selected' or '' }}>todos</option>
      <option value="unclassified" {{ 'unclassified' == only and 'selected' or '' }}>sin categoría</option>
      <option value="classified" {{ 'classified' == only and 'selected' or '' }}>clasificados</option>
    </select>
    <button type="submit">filtrar</button>
    {% if q or only %}
      <a class="link-reset" href="/">limpiar filtros</a>
    {% endif %}
  </form>
</section>

<!-- estadísticas -->
<section class="stats">
  {% set total = rows|length %}
  {% set clas = (rows | selectattr('classified') | list) | length %}
  {% set sin = total - clas %}
  <span>total: {{ total }}</span>
  <span>clasificados: {{ clas }}</span>
  <span>sin categoría: {{ sin }}</span>
</section>

{# primer PDF disponible (missing == 0); si no hay, queda None #}
{% set avail = rows | selectattr('missing','equalto',0) | list %}
{% set first = avail and avail[0] or None %}

<!-- lista + visor -->
<section class="grid">
  <div class="col list">
    <table class="table">
      <thead>
        <tr>
          <th>archivo</th>
          <th>origen</th>
          <th>estado</th>
          <th>categoría</th>
          <th>acciones</th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
      {% set fid = 'fcat-' ~ loop.index0 %}
      <tr class="{{ r.classified and 'row-ok' or 'row-pending' }}"
          {% if r.missing == 0 %}
            data-open-row
            data-path="{{ r.pdf_path }}"
            data-filename="{{ r.pdf_filename }}"
          {% endif %}>
        <td class="mono">{{ r.pdf_filename }}</td>
        <td>
          <div>zip: {{ r.zip_root }}</div>
          <div>año/bloque: {{ r.year }}/{{ r.block }}</div>
          <div class="tiny mono path">{{ r.pdf_path }}</div>
        </td>
        <td>
          {% if r.missing == 1 %}<span class="badge warn">no disponible</span>
          {% elif r.classified %}<span class="badge ok">clasificado</span>
          {% else %}<span class="badge pending">sin categoría</span>
          {% endif %}
        </td>

        <!-- select + form real -->
        <td>
          <form id="{{ fid }}" method="post" action="/assign">
            <input type="hidden" name="pdf_path" value="{{ r.pdf_path }}">
            <select name="category">
              <option value="" {{ (not r.category) and 'selected' or '' }}>— seleccionar —</option>
              {% for c in categories %}
                <option value="{{ c }}" {{ r.category == c and 'selected' or '' }}>{{ c }}</option>
              {% endfor %}
            </select>
          </form>
        </td>

        <!-- acciones -->
        <td class="actions">
          <button type="submit" form="{{ fid }}">guardar</button>

          {% if r.category %}
            <form method="post" action="/unassign" class="inline">
              <input type="hidden" name="pdf_path" value="{{ r.pdf_path }}">
              <button type="submit" class="ghost">quitar</button>
            </form>
          {% endif %}

          {% if r.missing == 0 %}
            <a class="ghost open-tab" href="/pdf?path={{ r.pdf_path | urlencode }}" target="_blank" rel="noopener">abrir en pestaña</a>
          {% else %}
            <button class="ghost" disabled>no disponible</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="col viewer">
    <div class="viewer-header">
      <span>previsualización</span>
      <span id="viewer-filename" class="mono tiny">
        {{ first and first.pdf_filename or '' }}
      </span>
    </div>
    <iframe id="pdf-viewer" title="pdf viewer"
            src="{{ first and ('/pdf?path=' ~ first.pdf_path|urlencode) or '' }}"
            frameborder="0"></iframe>
  </div>
</section>

<script>
  // visor
  const viewer = document.getElementById('pdf-viewer');
  const viewerName = document.getElementById('viewer-filename');

  function openPath(p, name){
    if (!p) return;
    viewer.src = '/pdf?path=' + encodeURIComponent(p);
    viewerName.textContent = name || (p.split('/').pop());
  }

  // 1) Inicializar con el primer disponible si existe en el HTML (server-side)
  (function initFirst(){
    const first = document.querySelector('[data-open-row]');
    if (first) openPath(first.getAttribute('data-path'), first.getAttribute('data-filename'));
  })();

  // 2) Delegación de eventos:
  document.addEventListener('click', (e) => {
    // ignorar si el clic fue en UI interactiva
    if (e.target.closest('td.actions, select, button, a, input, label')) return;

    const row = e.target.closest('[data-open-row]');
    if (!row) return;

    const p = row.getAttribute('data-path');
    const name = row.getAttribute('data-filename');
    openPath(p, name);
  });
</script>

{% endblock %}
